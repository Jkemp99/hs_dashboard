{% load core_extras %}
{% if students %}
<div class="overflow-x-auto">
    <table class="min-w-full leading-normal">
        <thead>
            <tr>
                <th
                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Name
                </th>
                <th
                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Grade
                </th>
                <th
                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Subjects
                </th>
                <th
                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Actions
                </th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">{{ student.name }}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">
                        {{ student.display_grade }}
                    </p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    {% if student.has_subjects %}
                    <button onclick="manageSubjects('{{ student.id|escapejs }}', '{{ student.name|escapejs }}')"
                        class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-1 px-3 rounded text-xs border border-purple-300">
                        Manage ({{ student.subject_count }})
                    </button>
                    {% else %}
                    <a href="{% url 'initialize_subjects' student.id %}"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-xs no-underline">
                        Auto-Fill Defaults
                    </a>
                    {% endif %}
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm flex items-center space-x-2">
                    <button type="button"
                        onclick="document.getElementById('edit-row-{{ student.id }}').style.display = 'table-row'; openEditStudentModal(this)"
                        data-id="{{ student.id }}" data-name="{{ student.name }}" data-grade="{{ student.grade_level }}"
                        data-custom-grade="{{ student.custom_grade_level }}"
                        data-grading-system="{{ student.grading_system }}"
                        data-start="{{ student.academic_year_start_month }}"
                        data-end="{{ student.academic_year_end_month }}"
                        class="text-blue-600 hover:text-blue-900 font-semibold">Edit</button>

                    <button type="button" hx-post="{% url 'delete_student' student.id %}"
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' hx-target="#student-list-container"
                        hx-confirm="Are you sure you want to delete this student? All their data will be lost."
                        class="text-red-600 hover:text-red-900 font-semibold">Delete</button>
                </td>
            </tr>
            <!-- Subjects List Row -->
            <tr id="subjects-row-{{ student.id }}" style="display: none;">
                <td colspan="4" class="px-5 py-5 border-b border-gray-200 bg-gray-50 text-sm">
                    <div class="pl-4">
                        <h4 class="font-bold text-gray-700 mb-2">Subjects for {{ student.name }}</h4>
                        <ul class="list-disc pl-5 mb-4">
                            {% for subject in student.subjects.all %}
                            <li class="mb-1 flex items-center">
                                <span class="mr-2">{{ subject.display_name }}</span>
                                <form method="post" action="{% url 'delete_subject' subject.id %}" class="inline"
                                    id="delete-subject-{{ subject.id }}">
                                    {% csrf_token %}
                                    <input type="hidden" name="subject_id" value="{{ subject.id }}">
                                    <button type="button"
                                        onclick="showDeleteModal('delete-subject-{{ subject.id }}', 'Are you sure you want to delete the subject &quot;{{ subject.display_name|escapejs }}&quot;?')"
                                        class="text-red-500 hover:text-red-700 text-xs">x</button>
                                </form>
                            </li>
                            {% empty %}
                            <li class="text-gray-500 italic">No subjects added yet.</li>
                            {% endfor %}
                        </ul>
                        <form method="post" action="{% url 'add_subject' %}" class="flex items-center flex-wrap gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="student_id" value="{{ student.id }}">
                            <select name="global_subject_id" id="subject_select_{{ student.id }}"
                                onchange="toggleCustomSubject({{ student.id }})"
                                class="shadow border rounded py-1 px-2 text-gray-700 text-sm">
                                <option value="">-- Select Subject --</option>
                                {% for gs in global_subjects %}
                                <option value="{{ gs.id }}">{{ gs.name }}</option>
                                {% endfor %}
                                <option value="custom">Other / Custom</option>
                            </select>
                            <input type="text" name="custom_name" id="custom_subject_{{ student.id }}"
                                placeholder="Custom Subject Name" style="display: none;"
                                class="shadow border rounded py-1 px-2 text-gray-700 text-sm">
                            <button type="submit"
                                class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded text-xs">Add</button>
                        </form>
                    </div>
                </td>
            </tr>
            <tr id="edit-row-{{ student.id }}" style="display: none;">
                <td colspan="4" class="px-5 py-5 border-b border-gray-200 bg-gray-50 text-sm">
                    <form method="post" hx-post="{% url 'add_edit_student' %}" hx-target="#student-list-container"
                        hx-swap="innerHTML" class="w-full">
                        {% csrf_token %}
                        <input type="hidden" name="student_id" value="{{ student.id }}">

                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-1">Student Name</label>
                                <input type="text" name="name" value="{{ student.name }}" required
                                    class="shadow appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-1">Grade Level</label>
                                <select name="grade_level" id="grade_level_{{ student.id }}"
                                    onchange="toggleInlineCustomGrade({{ student.id }})"
                                    class="shadow border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                                    {% for code, name in grade_choices %}
                                    <option value="{{ code }}" {% if student.grade_level|eq:code %}selected{% endif %}>
                                        {{ name }}</option>
                                    {% endfor %}
                                </select>
                                <div id="custom_grade_container_{{ student.id }}" class="mt-2"
                                    style="{% if student.grade_level != 'Other' %}display: none;{% endif %}">
                                    <input type="text" name="custom_grade_level"
                                        value="{{ student.custom_grade_level|default:'' }}"
                                        placeholder="Enter Grade Level"
                                        class="shadow appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-1">Grading System</label>
                                <select name="grading_system" id="grading_system_{{ student.id }}"
                                    class="shadow border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                                    {% if student.grading_system|eq:'quarters' %}
                                    <option value="quarters" selected>Quarters (Q1-Q4)</option>
                                    <option value="semesters">Semesters (Fall, Spring)</option>
                                    {% else %}
                                    <option value="quarters">Quarters (Q1-Q4)</option>
                                    <option value="semesters" selected>Semesters (Fall, Spring)</option>
                                    {% endif %}
                                </select>
                            </div>
                            <div></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-1">Academic Year Start</label>
                                <select name="academic_year_start_month" id="academic_year_start_month_{{ student.id }}"
                                    class="shadow border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                                    {% for month_val, month_name in months %}
                                    {% if student.academic_year_start_month|eq:month_val %}
                                    <option value="{{ month_val }}" selected>{{ month_name }}</option>
                                    {% else %}
                                    <option value="{{ month_val }}">{{ month_name }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-1">Academic Year End</label>
                                <select name="academic_year_end_month" id="academic_year_end_month_{{ student.id }}"
                                    class="shadow border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                                    {% for month_val, month_name in months %}
                                    {% if student.academic_year_end_month|eq:month_val %}
                                    <option value="{{ month_val }}" selected>{{ month_name }}</option>
                                    {% else %}
                                    <option value="{{ month_val }}">{{ month_name }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="flex items-center justify-end space-x-2">
                            <button type="button"
                                onclick="document.getElementById('edit-row-{{ student.id }}').style.display='none'"
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded text-sm">
                                Cancel
                            </button>
                            <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="text-gray-600">No students added yet.</p>
{% endif %}